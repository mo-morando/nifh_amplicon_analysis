##
## Create the nifH ASV database which has:
##  * Quality-filtered AUID sequences, abundances, and annotations
##  * Sample metadata
##  * CMAP environmental data
##
## The nifH ASV database is provided in two ways:
##  - nifH_ASV_database.tgz:  Separate files for each component of the DB
##  - workspace.RData:        R image with tables (data frames, tidy friendly) DB components and a
##                            few helper functions.
##
## Useful targets:
##   make timestamps	- Print timestamps for required inputs from previous workflow stages
##   make               - Make the nifH_ASV_database.tgz and workspace.RData
##   make all           - Same as previous
##   make clean         - Delete nifH_ASV_database.tgz and workspace.RData
##

SHELL=/usr/bin/bash

##
## Inputs generated by Makefiles from previously executed workflow stages.
##

## From FilterAuids stage
FILTDIR      := $(abspath ../FilterAuids)
FILTABUNDTAB := $(addprefix $(FILTDIR)/,auid.abundances.filtered.tsv.gz)
FILTFASTA    := $(addprefix $(FILTDIR)/,auid.filtered.fasta)

## From GatherMetadata stage
METADIR      := $(abspath ../GatherMetadata)
#CMAPMETA     := $(addprefix $(METADIR)/,metadata.cmap.csv)
SAMPMETA     := $(addprefix $(METADIR)/,metadata.csv)

## From AnnotateAuids stage
ANNOTDIR     := $(abspath ../AnnotateAuids)
ANNOTATION   := $(addprefix $(ANNOTDIR)/,auids.annot.tsv)

## From CMAP stage
CMAPDIR  := $(abspath ../CMAP)
CMAPDATA := $(addprefix $(CMAPDIR)/,data/CMAP_metadata.csv.gz)


##
## The one script for this stage, and its outputs.  The "sampsWithout" files are diagnostic and not
## part of the nifH ASV database.
##
MAKENIFHASVDB := $(abspath scripts/make_nifH_ASV_database.R)
INPUTS        := $(FILTABUNDTAB) $(FILTFASTA) $(ANNOTATION) $(SAMPMETA) $(CMAPDATA)
OUTPUTS       := nifH_ASV_database.tgz workspace.RData \
	         $(addprefix sampsWithout,Metadata.txt Envdata.txt)

all: timestamps $(OUTPUTS)

.PHONY: clean
clean:
	rm -f $(OUTPUTS)


## Sed captures the year, then drops filepath up through "nifH-ASV-workflow", assuming
## the user didn't rename the directory after cloning the Git repository.
.PHONY: timestamps
timestamps:
	@echo "Input file modification timestamps are as follows:"
	@stat --printf='%y\t%-16n\n' `ls -rt $(INPUTS)` \
	  | sed -e 's/\.[0-9][0-9]*.*\t/\t/' -e 's/  *.*\/nifH-ASV-workflow\//  /'
	@echo

## Make the nifH ASV database and the workspace
## fixme: nifH_ASV_database -> variable
$(OUTPUTS) &: $(INPUTS)
	@echo ">>>>> Making the nifH ASV database <<<<<"
	@$(MAKENIFHASVDB) $^
	@if [ -d "nifH_ASV_database" ] ; then \
	    tar cvfz nifH_ASV_database.tgz nifH_ASV_database &> /dev/null ; \
	    rm -rf nifH_ASV_database ; \
	fi
	@echo ">>>>> Finished making the nifH ASV database <<<<<"
	@echo
